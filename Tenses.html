<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc 12 th√¨ c√πng The Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f0f4f8;
        }
        .tense-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .tense-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .prose h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        .prose li {
            margin-bottom: 0.5rem;
        }
        .prose p {
            line-height: 1.6;
        }
        .prose strong {
            font-weight: 700;
        }
        .prose code {
            background-color: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* UPDATED: Drag and Drop styles */
        .reorder-word.dragging {
            opacity: 0.4;
        }
        .drag-placeholder {
            background-color: #e0e7ff;
            border: 2px dashed #a5b4fc;
            border-radius: 0.25rem;
            height: 40px; /* Match height of draggable items */
            flex-shrink: 0;
        }
        .exercise-frame {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: white;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <img src="https://placehold.co/32x32/6366f1/ffffff?text=TF" alt="Logo" class="h-8 w-8 mr-2 rounded-full">
                    <h1 class="text-xl font-bold text-slate-800">H·ªçc 12 th√¨ c√πng The Forum</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="homeBtn" class="text-slate-600 hover:bg-slate-100 font-medium px-3 py-2 rounded-md">Trang ch·ªß</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Main Dashboard View -->
        <div id="dashboard-view">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold mb-2">·ª®ng d·ª•ng h·ªçc 12 th√¨ c·ªßa The Forum</h2>
                <p class="text-slate-600 max-w-2xl mx-auto">T·∫°i ƒë√¢y, b·∫°n s·∫Ω ƒë∆∞·ª£c luy·ªán t·∫≠p c√°ch s·ª≠ d·ª•ng 12 th√¨ ti·∫øng Anh, k·∫øt h·ª£p l√Ω thuy·∫øt chi ti·∫øt v√† b√†i t·∫≠p t∆∞∆°ng t√°c do AI t·∫°o ra.</p>
                <p class="text-sm text-slate-500 mt-4 italic">L∆∞u √Ω: B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google ƒë·ªÉ s·ª≠ d·ª•ng ·ª©ng d·ª•ng n√†y.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- UPDATED: Added text-center class to center all content -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 flex flex-col text-center">
                    <h3 class="font-bold text-2xl mb-4 text-indigo-700">Ch·∫ø ƒë·ªô h·ªçc theo t·ª´ng th√¨</h3>
                    <p class="text-slate-600 mb-6">Ch·ªçn m·ªôt trong 12 th√¨ d∆∞·ªõi ƒë√¢y ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc l√Ω thuy·∫øt chuy√™n s√¢u v√† l√†m b√†i t·∫≠p c·ªßng c·ªë.</p>
                    <div class="mt-auto">
                        <select id="tense-select-dropdown" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-base focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-no-repeat bg-right pr-8" style="background-image: url('data:image/svg+xml;charset=utf-8,%3Csvg xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22 fill%3D%22none%22 viewBox%3D%220 0 20 20%22%3E%3Cpath stroke%3D%22%236b7280%22 stroke-linecap%3D%22round%22 stroke-linejoin%3D%22round%22 stroke-width%3D%221.5%22 d%3D%22M6 8l4 4 4-4%22%2F%3E%3C%2Fsvg%3E'); background-position: right 0.5rem center; background-size: 1.5em 1.5em;">
                            <!-- Options populated by JS -->
                        </select>
                        <button id="start-learning-btn" class="w-full mt-4 bg-indigo-600 text-white py-3 rounded-lg font-semibold btn hover:bg-indigo-700">B·∫Øt ƒë·∫ßu h·ªçc</button>
                    </div>
                </div>
                <!-- UPDATED: Added text-center class to center all content -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200 flex flex-col text-center">
                    <h3 class="font-bold text-2xl mb-4 text-teal-700">Ch·∫ø ƒë·ªô luy·ªán t·∫≠p n√¢ng cao</h3>
                    <p class="text-slate-600 mb-6">Th·ª≠ th√°ch b·∫£n th√¢n v·ªõi c√°c b√†i t·∫≠p ng·∫´u nhi√™n, t·ªïng h·ª£p t·ª´ t·∫•t c·∫£ 12 th√¨ ƒë·ªÉ ki·ªÉm tra to√†n di·ªán ki·∫øn th·ª©c c·ªßa b·∫°n.</p>
                    <button id="advanced-practice-btn" class="w-full mt-auto bg-teal-600 text-white py-3 rounded-lg font-semibold btn hover:bg-teal-700 flex items-center justify-center">
                        B·∫Øt ƒë·∫ßu luy·ªán t·∫≠p t·ªïng h·ª£p
                    </button>
                </div>
            </div>
        </div>

        <!-- Learning/Practice View -->
        <div id="learning-view" class="hidden">
            <button id="back-to-dashboard" class="mb-6 inline-flex items-center text-indigo-600 hover:text-indigo-800 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                </svg>
                Quay l·∫°i trang ch√≠nh
            </button>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Theory Section -->
                <div id="theory-section" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-slate-200 self-start">
                    <h2 id="tense-title" class="text-2xl font-bold mb-4"></h2>
                    <div id="tense-theory" class="prose max-w-none"></div>
                    <hr class="my-6">
                    <div id="ai-example-generator">
                        <h3 class="text-lg font-semibold mb-3">‚ú® T·∫°o c√¢u v√≠ d·ª• v·ªõi AI</h3>
                        <p class="text-sm text-slate-600 mb-3">Nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ (v√≠ d·ª•: "c√¥ng vi·ªác", "du l·ªãch") ƒë·ªÉ AI t·∫°o c√¢u v√≠ d·ª• th·ª±c t·∫ø.</p>
                        <input type="text" id="example-topic-input" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ ·ªü ƒë√¢y..." class="w-full p-2 border border-slate-300 rounded-lg mb-3">
                        <button id="generate-example-btn" class="btn bg-fuchsia-600 text-white w-full py-2 rounded-lg font-semibold hover:bg-fuchsia-700 flex items-center justify-center">
                            T·∫°o v√≠ d·ª•
                        </button>
                        <div id="example-output" class="mt-4 prose max-w-none"></div>
                    </div>
                </div>

                <!-- Exercise Section -->
                <div id="exercise-section" class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">B√†i t·∫≠p th·ª±c h√†nh</h3>
                        <div id="progress-indicator" class="font-medium text-slate-600 bg-slate-100 px-3 py-1 rounded-full"></div>
                    </div>
                    
                    <div id="question-container" class="min-h-[200px] flex flex-col justify-center">
                        <!-- Question content or loader will be injected here -->
                    </div>
                    
                    <div id="feedback-container" class="min-h-[50px] my-4 p-3 rounded-lg text-left font-medium"></div>

                    <!-- Button Layout -->
                    <div class="flex items-center justify-between gap-4">
                        <!-- Left Button -->
                        <button id="prev-btn" class="btn bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-lg font-semibold">C√¢u tr∆∞·ªõc</button>
                        
                        <!-- Middle Buttons -->
                        <div class="flex items-center gap-2">
                           <button id="analyze-btn" class="btn bg-amber-500 text-white px-4 py-2 rounded-lg font-semibold hidden hover:bg-amber-600 flex items-center justify-center">‚ú® Ph√¢n t√≠ch l·ªói sai</button>
                           <button id="check-btn" class="btn bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700">Ki·ªÉm tra</button>
                        </div>
                        
                        <!-- Right Button -->
                        <button id="next-btn" class="btn bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-lg font-semibold">C√¢u sau</button>
                    </div>

                    <hr class="my-6">
                    
                    <div class="text-center">
                        <button id="load-more-btn" class="btn bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hidden hover:bg-green-700 flex items-center justify-center">‚ú® T·∫°o 10 c√¢u h·ªèi m·ªõi</button>
                        <button id="finish-session-btn" class="btn bg-rose-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-rose-700">K·∫øt th√∫c bu·ªïi h·ªçc</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- AI Analysis Modal -->
    <div id="ai-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-w-3xl m-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold">‚ú® Ph√¢n t√≠ch chuy√™n s√¢u t·ª´ AI</h3>
                <button id="close-ai-modal" class="text-slate-500 hover:text-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="ai-explanation" class="p-6 prose max-w-none max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <!-- End Session Modal -->
    <div id="end-session-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-md m-4 p-6 text-center">
            <h3 class="text-xl font-bold mb-4">B·∫°n mu·ªën k·∫øt th√∫c bu·ªïi h·ªçc?</h3>
            <p class="text-slate-600 mb-6">Ch·ªçn m·ªôt trong c√°c t√πy ch·ªçn d∆∞·ªõi ƒë√¢y ƒë·ªÉ ti·∫øp t·ª•c.</p>
            <div class="flex flex-col space-y-3">
                <button id="generate-report-btn" class="btn bg-sky-600 text-white w-full py-3 rounded-lg font-semibold hover:bg-sky-700">T·∫°o b√°o c√°o c√° nh√¢n h√≥a</button>
                <button id="confirm-end-btn" class="btn bg-slate-600 text-white w-full py-3 rounded-lg font-semibold hover:bg-slate-700">K·∫øt th√∫c bu·ªïi h·ªçc</button>
                <button id="cancel-end-btn" class="btn bg-transparent text-slate-600 w-full py-2 rounded-lg font-medium hover:bg-slate-100">Ti·∫øp t·ª•c h·ªçc</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl m-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold">B√°o c√°o k·∫øt qu·∫£ h·ªçc t·∫≠p</h3>
                <button id="close-report-modal" class="text-slate-500 hover:text-slate-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="report-content" class="p-6 max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const dashboardView = document.getElementById('dashboard-view');
            const learningView = document.getElementById('learning-view');
            const tenseSelectDropdown = document.getElementById('tense-select-dropdown');
            const startLearningBtn = document.getElementById('start-learning-btn');
            const backToDashboardBtn = document.getElementById('back-to-dashboard');
            const homeBtn = document.getElementById('homeBtn');
            const advancedPracticeBtn = document.getElementById('advanced-practice-btn');

            const theorySection = document.getElementById('theory-section');
            const tenseTitle = document.getElementById('tense-title');
            const tenseTheory = document.getElementById('tense-theory');
            const generateExampleBtn = document.getElementById('generate-example-btn');
            const exampleTopicInput = document.getElementById('example-topic-input');
            const exampleOutput = document.getElementById('example-output');
            
            const exerciseSection = document.getElementById('exercise-section');
            const progressIndicator = document.getElementById('progress-indicator');
            const questionContainer = document.getElementById('question-container');
            const feedbackContainer = document.getElementById('feedback-container');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const checkBtn = document.getElementById('check-btn');
            const analyzeBtn = document.getElementById('analyze-btn');
            const loadMoreBtn = document.getElementById('load-more-btn');
            const finishSessionBtn = document.getElementById('finish-session-btn');

            const aiModal = document.getElementById('ai-modal');
            const closeAiModalBtn = document.getElementById('close-ai-modal');
            const aiExplanation = document.getElementById('ai-explanation');

            const endSessionModal = document.getElementById('end-session-modal');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const confirmEndBtn = document.getElementById('confirm-end-btn');
            const cancelEndBtn = document.getElementById('cancel-end-btn');

            const reportModal = document.getElementById('report-modal');
            const closeReportModalBtn = document.getElementById('close-report-modal');
            const reportContent = document.getElementById('report-content');

            // --- APP STATE ---
            let state = {
                currentMode: 'dashboard', // dashboard, learning, advanced
                currentTenseId: null,
                currentTenseName: null,
                questions: [],
                currentQuestionIndex: 0,
                userAnswers: [],
                startTime: null,
            };
            
            // --- DATA ---
            const tenses = [
                { id: 'present_simple', name: 'Hi·ªán t·∫°i ƒë∆°n' },
                { id: 'present_continuous', name: 'Hi·ªán t·∫°i ti·∫øp di·ªÖn' },
                { id: 'present_perfect', name: 'Hi·ªán t·∫°i ho√†n th√†nh' },
                { id: 'present_perfect_continuous', name: 'HTHT ti·∫øp di·ªÖn' },
                { id: 'past_simple', name: 'Qu√° kh·ª© ƒë∆°n' },
                { id: 'past_continuous', name: 'Qu√° kh·ª© ti·∫øp di·ªÖn' },
                { id: 'past_perfect', name: 'Qu√° kh·ª© ho√†n th√†nh' },
                { id: 'past_perfect_continuous', name: 'QKHT ti·∫øp di·ªÖn' },
                { id: 'future_simple', name: 'T∆∞∆°ng lai ƒë∆°n' },
                { id: 'future_continuous', name: 'T∆∞∆°ng lai ti·∫øp di·ªÖn' },
                { id: 'future_perfect', name: 'T∆∞∆°ng lai ho√†n th√†nh' },
                { id: 'future_perfect_continuous', name: 'TLHT ti·∫øp di·ªÖn' },
            ];

            const theoryData = {
                present_simple: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + V(s/es) + O\n- **Ph·ªß ƒë·ªãnh:** S + do/does + not + V(bare) + O\n- **Nghi v·∫•n:** Do/Does + S + V(bare) + O?\n\n### 2. C√°ch d√πng (Usage)\n- Di·ªÖn t·∫£ m·ªôt th√≥i quen, h√†nh ƒë·ªông l·∫∑p ƒëi l·∫∑p l·∫°i ·ªü hi·ªán t·∫°i (always, usually, often, sometimes, never...).\n- Di·ªÖn t·∫£ m·ªôt ch√¢n l√Ω, s·ª± th·∫≠t hi·ªÉn nhi√™n.\n- L·ªãch tr√¨nh, th·ªùi gian bi·ªÉu (t√†u, xe, phim ·∫£nh).\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "I usually **read** books in my free time to broaden my horizons."\n- *Giao ti·∫øp:* "The sun **rises** in the East."\n- *L·ªãch tr√¨nh:* "The train to Hanoi **leaves** at 8 PM."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **Hi·ªán t·∫°i ƒë∆°n vs. Hi·ªán t·∫°i ti·∫øp di·ªÖn:** HTƒê n√≥i v·ªÅ th√≥i quen, s·ª± th·∫≠t (lu√¥n ƒë√∫ng), trong khi HTTD n√≥i v·ªÅ h√†nh ƒë·ªông ƒëang di·ªÖn ra t·∫°i th·ªùi ƒëi·ªÉm n√≥i.\n  - *He **works** as a doctor.* (Ngh·ªÅ nghi·ªáp c·ªßa anh ·∫•y)\n  - *He **is working** in the garden now.* (H√†nh ƒë·ªông t·∫°m th·ªùi)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** Lu√¥n nh·ªõ th√™m \`-s\`/\`-es\` cho ƒë·ªông t·ª´ ƒëi v·ªõi ng√¥i th·ª© ba s·ªë √≠t (he, she, it).\n- **L·ªói sai:** Qu√™n chia ƒë·ªông t·ª´. *Sai: She **go** to school.* -> *ƒê√∫ng: She **goes** to school.*`,
                present_continuous: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + am/is/are + V-ing\n- **Ph·ªß ƒë·ªãnh:** S + am/is/are + not + V-ing\n- **Nghi v·∫•n:** Am/Is/Are + S + V-ing?\n\n### 2. C√°ch d√πng (Usage)\n- H√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i th·ªùi ƒëi·ªÉm n√≥i (now, at the moment).\n- H√†nh ƒë·ªông ƒëang di·ªÖn ra xung quanh th·ªùi ƒëi·ªÉm n√≥i (nh∆∞ng kh√¥ng nh·∫•t thi·∫øt ngay l√∫c n√≥i).\n- K·∫ø ho·∫°ch ch·∫Øc ch·∫Øn trong t∆∞∆°ng lai g·∫ßn (c√≥ th·ªùi gian, ƒë·ªãa ƒëi·ªÉm c·ª• th·ªÉ).\n- Ph√†n n√†n v·ªÅ m·ªôt h√†nh ƒë·ªông l·∫∑p ƒëi l·∫∑p l·∫°i g√¢y kh√≥ ch·ªãu (v·ªõi 'always', 'constantly').\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "As you can see from the chart, the number of tourists **is increasing** steadily."\n- *Giao ti·∫øp:* "Please be quiet. The baby **is sleeping**."\n- *T∆∞∆°ng lai g·∫ßn:* "I **am meeting** my professor tomorrow at 10 AM."\n- *Ph√†n n√†n:* "He **is always losing** his keys!"\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **Hi·ªán t·∫°i ti·∫øp di·ªÖn vs. Hi·ªán t·∫°i ƒë∆°n:** HTTD di·ªÖn t·∫£ h√†nh ƒë·ªông t·∫°m th·ªùi, trong khi HTƒê di·ªÖn t·∫£ s·ª± vi·ªác l√¢u d√†i, ·ªïn ƒë·ªãnh.\n  - *I **am living** with my parents until I find my own apartment.* (T·∫°m th·ªùi)\n  - *I **live** with my parents.* (L√¢u d√†i)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** D·∫•u hi·ªáu nh·∫≠n bi·∫øt l√† c√°c tr·∫°ng t·ª´ ch·ªâ th·ªùi gian nh∆∞ 'now', 'right now', 'at the moment', 'at present'.\n- **L·ªói sai:** D√πng v·ªõi c√°c ƒë·ªông t·ª´ ch·ªâ tr·∫°ng th√°i (stative verbs) nh∆∞ 'know', 'believe', 'want', 'need'. *Sai: I **am wanting** a cup of coffee.* -> *ƒê√∫ng: I **want** a cup of coffee.*`,
                present_perfect: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + have/has + V3/ed\n- **Ph·ªß ƒë·ªãnh:** S + have/has + not + V3/ed\n- **Nghi v·∫•n:** Have/Has + S + V3/ed?\n\n### 2. C√°ch d√πng (Usage)\n- H√†nh ƒë·ªông ƒë√£ x·∫£y ra trong qu√° kh·ª© nh∆∞ng kh√¥ng r√µ th·ªùi gian, k·∫øt qu·∫£ c√≤n li√™n quan ƒë·∫øn hi·ªán t·∫°i.\n- Tr·∫£i nghi·ªám ho·∫∑c kinh nghi·ªám s·ªëng (v·ªõi 'ever', 'never', 'before').\n- H√†nh ƒë·ªông b·∫Øt ƒë·∫ßu trong qu√° kh·ª©, k√©o d√†i ƒë·∫øn hi·ªán t·∫°i (v·ªõi 'for', 'since').\n- H√†nh ƒë·ªông v·ª´a m·ªõi x·∫£y ra (v·ªõi 'just', 'recently', 'lately').\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Writing:* "The government **has implemented** several policies to tackle unemployment." (K·∫øt qu·∫£ l√† c√°c ch√≠nh s√°ch ƒëang c√≥ hi·ªáu l·ª±c)\n- *Giao ti·∫øp (Tr·∫£i nghi·ªám):* "**Have** you ever **been** to Japan?"\n- *Giao ti·∫øp (K√©o d√†i):* "She **has lived** here for ten years."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **Hi·ªán t·∫°i ho√†n th√†nh vs. Qu√° kh·ª© ƒë∆°n:** HTHT kh√¥ng nh·∫•n m·∫°nh th·ªùi gian, QKƒê lu√¥n ƒëi v·ªõi th·ªùi gian x√°c ƒë·ªãnh trong qu√° kh·ª©.\n  - *I **have seen** that movie.* (Kh√¥ng r√µ xem khi n√†o)\n  - *I **saw** that movie yesterday.* (R√µ th·ªùi gian l√† 'yesterday')\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** Nh·ªõ c√°c tr·∫°ng t·ª´ ƒë·∫∑c tr∆∞ng: 'just', 'yet', 'already', 'ever', 'never', 'for', 'since'.\n- **L·ªói sai:** D√πng HTHT v·ªõi m·ªëc th·ªùi gian ƒë√£ k·∫øt th√∫c. *Sai: I **have finished** my homework yesterday.* -> *ƒê√∫ng: I **finished** my homework yesterday.*`,
                present_perfect_continuous: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + have/has + been + V-ing\n- **Ph·ªß ƒë·ªãnh:** S + have/has + not + been + V-ing\n- **Nghi v·∫•n:** Have/Has + S + been + V-ing?\n\n### 2. C√°ch d√πng (Usage)\n- Nh·∫•n m·∫°nh t√≠nh li√™n t·ª•c c·ªßa h√†nh ƒë·ªông b·∫Øt ƒë·∫ßu trong qu√° kh·ª©, k√©o d√†i ƒë·∫øn hi·ªán t·∫°i.\n- H√†nh ƒë·ªông v·ª´a m·ªõi k·∫øt th√∫c v√† ƒë·ªÉ l·∫°i k·∫øt qu·∫£ c√≥ th·ªÉ th·∫•y ·ªü hi·ªán t·∫°i.\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "I'm a bit tired because I'**ve been studying** for my exam all night." (Nh·∫•n m·∫°nh s·ª± li√™n t·ª•c v√† k·∫øt qu·∫£ l√† 'm·ªát')\n- *Giao ti·∫øp:* "Why are your clothes so dirty?" - "I'**ve been gardening**."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **HTHT ti·∫øp di·ªÖn vs. HT ho√†n th√†nh:** HTHTTD nh·∫•n m·∫°nh qu√° tr√¨nh, HTHT nh·∫•n m·∫°nh k·∫øt qu·∫£.\n  - *I'**ve been reading** that book.* (T√¥i ƒëang ƒë·ªçc n√≥, ch∆∞a xong)\n  - *I'**ve read** that book.* (T√¥i ƒë√£ ƒë·ªçc xong n√≥)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** Th∆∞·ªùng ƒëi v·ªõi 'for', 'since', 'all day', 'all morning' ƒë·ªÉ nh·∫•n m·∫°nh kho·∫£ng th·ªùi gian.\n- **L·ªói sai:** D√πng v·ªõi c√°c ƒë·ªông t·ª´ ch·ªâ tr·∫°ng th√°i. *Sai: I'**ve been knowing** him for years.* -> *ƒê√∫ng: I'**ve known** him for years.*`,
                past_simple: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + V2/ed\n- **Ph·ªß ƒë·ªãnh:** S + did + not + V(bare)\n- **Nghi v·∫•n:** Did + S + V(bare)?\n\n### 2. C√°ch d√πng (Usage)\n- H√†nh ƒë·ªông ƒë√£ x·∫£y ra v√† ch·∫•m d·ª©t ho√†n to√†n trong qu√° kh·ª©, c√≥ th·ªùi gian x√°c ƒë·ªãnh.\n- M·ªôt chu·ªói c√°c h√†nh ƒë·ªông x·∫£y ra li√™n ti·∫øp trong qu√° kh·ª©.\n- Th√≥i quen trong qu√° kh·ª© (th∆∞·ªùng d√πng v·ªõi 'used to').\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Writing Task 2:* "In the 20th century, technological advancements **revolutionized** the communication industry."\n- *Giao ti·∫øp (Chu·ªói h√†nh ƒë·ªông):* "Yesterday, I **woke up**, **had** breakfast, and **went** to work."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **Qu√° kh·ª© ƒë∆°n vs. Hi·ªán t·∫°i ho√†n th√†nh:** QKƒê d√πng cho h√†nh ƒë·ªông ƒë√£ ch·∫•m d·ª©t, c√≥ th·ªùi gian c·ª• th·ªÉ. HTHT d√πng cho h√†nh ƒë·ªông c√≥ li√™n quan ƒë·∫øn hi·ªán t·∫°i, kh√¥ng r√µ th·ªùi gian.\n  - *He **lived** in London for 5 years.* (B√¢y gi·ªù anh ·∫•y kh√¥ng s·ªëng ·ªü ƒë√≥ n·ªØa)\n  - *He **has lived** in London for 5 years.* (Anh ·∫•y v·∫´n ƒëang s·ªëng ·ªü ƒë√≥)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** D·∫•u hi·ªáu l√† c√°c tr·∫°ng t·ª´ ch·ªâ th·ªùi gian qu√° kh·ª©: 'yesterday', 'last week', 'in 1999', 'ago'.\n- **L·ªói sai:** D√πng ƒë·ªông t·ª´ qu√° kh·ª© sau tr·ª£ ƒë·ªông t·ª´ 'did'. *Sai: I **didn't went** to the party.* -> *ƒê√∫ng: I **didn't go** to the party.*`,
                past_continuous: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + was/were + V-ing\n- **Ph·ªß ƒë·ªãnh:** S + was/were + not + V-ing\n- **Nghi v·∫•n:** Was/Were + S + V-ing?\n\n### 2. C√°ch d√πng (Usage)\n- H√†nh ƒë·ªông ƒëang x·∫£y ra t·∫°i m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong qu√° kh·ª©.\n- M·ªôt h√†nh ƒë·ªông ƒëang x·∫£y ra (QKTD) th√¨ m·ªôt h√†nh ƒë·ªông kh√°c xen v√†o (QKƒê).\n- Hai h√†nh ƒë·ªông x·∫£y ra ƒë·ªìng th·ªùi trong qu√° kh·ª© (th∆∞·ªùng n·ªëi b·∫±ng 'while').\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "I remember it clearly. At this time last year, I **was preparing** for my final exams."\n- *Giao ti·∫øp (H√†nh ƒë·ªông xen v√†o):* "I **was watching** TV when the phone **rang**."\n- *Giao ti·∫øp (H√†nh ƒë·ªông song song):* "While my mom **was cooking**, I **was doing** my homework."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **Qu√° kh·ª© ti·∫øp di·ªÖn vs. Qu√° kh·ª© ƒë∆°n:** QKTD m√¥ t·∫£ b·ªëi c·∫£nh, h√†nh ƒë·ªông n·ªÅn. QKƒê m√¥ t·∫£ h√†nh ƒë·ªông ch√≠nh, ng·∫Øn g·ªçn xen v√†o.\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** C·∫•u tr√∫c kinh ƒëi·ªÉn: \`When + S + V(QKƒê), S + was/were + V-ing\` v√† \`While + S + was/were + V-ing, S + V(QKƒê)\`.\n- **L·ªói sai:** Nh·∫ßm l·∫´n gi·ªØa 'was' (s·ªë √≠t) v√† 'were' (s·ªë nhi·ªÅu v√† 'you'). *Sai: You **was** studying.* -> *ƒê√∫ng: You **were** studying.*`,
                past_perfect: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + had + V3/ed\n- **Ph·ªß ƒë·ªãnh:** S + had + not + V3/ed\n- **Nghi v·∫•n:** Had + S + V3/ed?\n\n### 2. C√°ch d√πng (Usage)\n- Di·ªÖn t·∫£ m·ªôt h√†nh ƒë·ªông ƒë√£ x·∫£y ra v√† ho√†n t·∫•t tr∆∞·ªõc m·ªôt h√†nh ƒë·ªông kh√°c ho·∫∑c m·ªôt th·ªùi ƒëi·ªÉm kh√°c trong qu√° kh·ª©.\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Writing:* "By the time the new regulations were introduced, many companies **had** already **moved** their factories overseas."\n- *Giao ti·∫øp:* "When I arrived at the station, the train **had** already **left**."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **Qu√° kh·ª© ho√†n th√†nh vs. Qu√° kh·ª© ƒë∆°n:** QKHT l√† th√¨ "qu√° kh·ª© c·ªßa qu√° kh·ª©". N√≥ x·∫£y ra tr∆∞·ªõc m·ªôt h√†nh ƒë·ªông QKƒê kh√°c.\n  - *He **told** me he **had lost** his wallet.* (Vi·ªác 'm·∫•t v√≠' x·∫£y ra tr∆∞·ªõc vi·ªác 'k·ªÉ')\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** Nh·ªõ c√¥ng th·ª©c v·ªõi 'before' v√† 'after': \`S + V(QKƒê) + before + S + had + V3/ed\` v√† \`After + S + had + V3/ed, S + V(QKƒê)\`.\n- **L·ªói sai:** L·∫°m d·ª•ng khi kh√¥ng c·∫ßn thi·∫øt. N·∫øu c√°c h√†nh ƒë·ªông x·∫£y ra theo tr√¨nh t·ª± th·ªùi gian, ch·ªâ c·∫ßn d√πng QKƒê. *Sai: I **had woken up** and **had had** breakfast.* -> *ƒê√∫ng: I **woke up** and **had** breakfast.*`,
                past_perfect_continuous: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + had + been + V-ing\n- **Ph·ªß ƒë·ªãnh:** S + had + not + been + V-ing\n- **Nghi v·∫•n:** Had + S + been + V-ing?\n\n### 2. C√°ch d√πng (Usage)\n- Nh·∫•n m·∫°nh t√≠nh li√™n t·ª•c c·ªßa m·ªôt h√†nh ƒë·ªông ƒë√£ x·∫£y ra k√©o d√†i tr∆∞·ªõc m·ªôt h√†nh ƒë·ªông kh√°c trong qu√° kh·ª©.\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "My eyes were sore because I **had been reading** for five hours before I went to bed."\n- *Giao ti·∫øp:* "They **had been waiting** for an hour before the bus finally arrived."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **QKHT ti·∫øp di·ªÖn vs. QK ho√†n th√†nh:** T∆∞∆°ng t·ª± c·∫∑p HTHT, QKHTTD nh·∫•n m·∫°nh qu√° tr√¨nh, QKHT nh·∫•n m·∫°nh s·ª± ho√†n t·∫•t.\n  - *He was tired because he **had been running**.* (Nh·∫•n m·∫°nh vi·ªác ch·∫°y)\n  - *He **had run** 5km before he felt tired.* (Nh·∫•n m·∫°nh k·∫øt qu·∫£ l√† ƒë√£ ch·∫°y ƒë∆∞·ª£c 5km)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** D√πng ƒë·ªÉ gi·∫£i th√≠ch nguy√™n nh√¢n cho m·ªôt t√¨nh tr·∫°ng ho·∫∑c s·ª± vi·ªác trong qu√° kh·ª©.\n- **L·ªói sai:** T∆∞∆°ng t·ª± c√°c th√¨ ti·∫øp di·ªÖn kh√°c, kh√¥ng d√πng v·ªõi ƒë·ªông t·ª´ tr·∫°ng th√°i.`,
                future_simple: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + will + V(bare)\n- **Ph·ªß ƒë·ªãnh:** S + will + not (won't) + V(bare)\n- **Nghi v·∫•n:** Will + S + V(bare)?\n\n### 2. C√°ch d√πng (Usage)\n- Quy·∫øt ƒë·ªãnh t·ª©c th·ªùi t·∫°i th·ªùi ƒëi·ªÉm n√≥i.\n- ƒê∆∞a ra l·ªùi h·ª©a, l·ªùi ƒë·ªÅ ngh·ªã, l·ªùi y√™u c·∫ßu.\n- D·ª± ƒëo√°n kh√¥ng c√≥ cƒÉn c·ª© ch·∫Øc ch·∫Øn.\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "In the future, I think more people **will work** from home due to advancements in technology." (D·ª± ƒëo√°n)\n- *Giao ti·∫øp (Quy·∫øt ƒë·ªãnh t·ª©c th·ªùi):* "It's cold in here. I'**ll close** the window."\n- *Giao ti·∫øp (L·ªùi h·ª©a):* "I promise I **will call** you tonight."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **T∆∞∆°ng lai ƒë∆°n vs. Be going to:** 'Will' d√πng cho quy·∫øt ƒë·ªãnh t·ª©c th·ªùi, d·ª± ƒëo√°n kh√¥ng cƒÉn c·ª©. 'Be going to' d√πng cho k·∫ø ho·∫°ch ƒë√£ c√≥ t·ª´ tr∆∞·ªõc, d·ª± ƒëo√°n c√≥ cƒÉn c·ª©.\n  - *Look at those dark clouds! It'**s going to rain**.* (C√≥ cƒÉn c·ª©)\n  - *I think it **will rain** tomorrow.* (Kh√¥ng c√≥ cƒÉn c·ª©)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** 'Will' th∆∞·ªùng ƒëi v·ªõi c√°c c·ª•m t·ª´ nh∆∞ 'I think', 'I guess', 'I promise', 'probably'.\n- **L·ªói sai:** D√πng 'will' cho k·∫ø ho·∫°ch ƒë√£ ƒë·ªãnh s·∫µn. *Sai: I **will visit** my aunt this weekend. I already bought the tickets.* -> *ƒê√∫ng: I **am going to visit**...* ho·∫∑c *I **am visiting**...*`,
                future_continuous: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + will + be + V-ing\n- **Ph·ªß ƒë·ªãnh:** S + will + not + be + V-ing\n- **Nghi v·∫•n:** Will + S + be + V-ing?\n\n### 2. C√°ch d√πng (Usage)\n- M·ªôt h√†nh ƒë·ªông s·∫Ω ƒëang di·ªÖn ra t·∫°i m·ªôt th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong t∆∞∆°ng lai.\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "It's hard to say for sure, but I imagine that in 20 years, we **will be using** flying cars."\n- *Giao ti·∫øp:* "Don't call me at 8 PM tonight. I **will be having** dinner with my family."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **TL ti·∫øp di·ªÖn vs. TL ƒë∆°n:** TLTD m√¥ t·∫£ m·ªôt h√†nh ƒë·ªông k√©o d√†i t·∫°i m·ªôt ƒëi·ªÉm th·ªùi gian t∆∞∆°ng lai, trong khi TLƒê ch·ªâ n√≥i v·ªÅ m·ªôt h√†nh ƒë·ªông s·∫Ω x·∫£y ra.\n  - *At 9 AM tomorrow, I **will be taking** my exam.* (H√†nh ƒë·ªông 'l√†m b√†i thi' ƒëang di·ªÖn ra l√∫c 9h)\n  - *The exam **will start** at 9 AM tomorrow.* (H√†nh ƒë·ªông 'b·∫Øt ƒë·∫ßu' x·∫£y ra l√∫c 9h)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** C·∫•u tr√∫c th∆∞·ªùng g·∫∑p l√†: \`At + [gi·ªù] + [th·ªùi gian t∆∞∆°ng lai], S + will be + V-ing\`.\n- **L·ªói sai:** D√πng cho d·ª± ƒëo√°n chung chung kh√¥ng c√≥ th·ªùi gian c·ª• th·ªÉ.`,
                future_perfect: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + will + have + V3/ed\n- **Ph·ªß ƒë·ªãnh:** S + will + not + have + V3/ed\n- **Nghi v·∫•n:** Will + S + have + V3/ed?\n\n### 2. C√°ch d√πng (Usage)\n- M·ªôt h√†nh ƒë·ªông s·∫Ω ho√†n t·∫•t tr∆∞·ªõc m·ªôt th·ªùi ƒëi·ªÉm ho·∫∑c m·ªôt h√†nh ƒë·ªông kh√°c trong t∆∞∆°ng lai.\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Writing:* "By 2050, scientists predict that we **will have found** solutions to many current environmental problems."\n- *Giao ti·∫øp:* "By the time you arrive, I **will have finished** my homework."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **TL ho√†n th√†nh vs. TL ƒë∆°n:** TLHT nh·∫•n m·∫°nh s·ª± ho√†n t·∫•t c·ªßa h√†nh ƒë·ªông tr∆∞·ªõc m·ªôt m·ªëc th·ªùi gian t∆∞∆°ng lai.\n  - *I **will finish** the report.* (S·∫Ω ho√†n th√†nh, kh√¥ng r√µ khi n√†o)\n  - *I **will have finished** the report by 5 PM.* (Ch·∫Øc ch·∫Øn xong tr∆∞·ªõc 5h)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** D·∫•u hi·ªáu nh·∫≠n bi·∫øt l√† c√°c c·ª•m t·ª´ \`by + [th·ªùi gian t∆∞∆°ng lai]\` ho·∫∑c \`by the time + [m·ªánh ƒë·ªÅ hi·ªán t·∫°i ƒë∆°n]\`.\n- **L·ªói sai:** D√πng m·ªánh ƒë·ªÅ t∆∞∆°ng lai sau 'by the time'. *Sai: By the time you **will arrive**...* -> *ƒê√∫ng: By the time you **arrive**...*`,
                future_perfect_continuous: `### 1. C·∫•u tr√∫c (Structure)\n- **Kh·∫≥ng ƒë·ªãnh:** S + will + have + been + V-ing\n- **Ph·ªß ƒë·ªãnh:** S + will + not + have + been + V-ing\n- **Nghi v·∫•n:** Will + S + have + been + V-ing?\n\n### 2. C√°ch d√πng (Usage)\n- Nh·∫•n m·∫°nh t√≠nh li√™n t·ª•c c·ªßa m·ªôt h√†nh ƒë·ªông k√©o d√†i ƒë·∫øn m·ªôt th·ªùi ƒëi·ªÉm n√†o ƒë√≥ trong t∆∞∆°ng lai.\n\n### 3. V√≠ d·ª• (Examples)\n- *IELTS Speaking:* "By the end of this year, I **will have been working** at this company for a decade."\n- *Giao ti·∫øp:* "Next month, we **will have been living** in this house for three years."\n\n### 4. So s√°nh v·ªõi th√¨ kh√°c\n- **TLHT ti·∫øp di·ªÖn vs. TL ho√†n th√†nh:** TLHTTD nh·∫•n m·∫°nh kho·∫£ng th·ªùi gian h√†nh ƒë·ªông di·ªÖn ra. TLHT nh·∫•n m·∫°nh s·ª± ho√†n t·∫•t.\n  - *By 6 PM, I **will have been cooking** for two hours.* (Nh·∫•n m·∫°nh qu√° tr√¨nh n·∫•u 2 ti·∫øng)\n  - *By 6 PM, I **will have cooked** dinner.* (Nh·∫•n m·∫°nh k·∫øt qu·∫£ l√† b·ªØa t·ªëi ƒë√£ xong)\n\n### 5. M·∫πo ghi nh·ªõ v√† l·ªói th∆∞·ªùng g·∫∑p\n- **M·∫πo:** Th∆∞·ªùng d√πng ƒë·ªÉ t√≠nh to√°n m·ªôt h√†nh ƒë·ªông ƒë√£ k√©o d√†i bao l√¢u t√≠nh ƒë·∫øn m·ªôt m·ªëc th·ªùi gian trong t∆∞∆°ng lai.\n- **L·ªói sai:** R·∫•t √≠t ph·ªï bi·∫øn trong giao ti·∫øp h√†ng ng√†y, ch·ªß y·∫øu d√πng trong c√°c ng·ªØ c·∫£nh c·∫ßn s·ª± trang tr·ªçng ho·∫∑c ch√≠nh x√°c cao.`
            };

            // --- GEMINI API INTEGRATION ---
            const API_KEY = "AIzaSyDNQZm1JNAWEHfzJkqkFiHqCoziZ8teksA"; // Use API Key from environment
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            
            async function callGemini(prompt, generationConfig = {}) {
                try {
                    const payload = {
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        generationConfig
                    };
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    }
                    throw new Error("No content received from API.");
                } catch (error) {
                    console.error("Gemini API call error:", error);
                    return null;
                }
            }

            async function AIGenerateExercises(tenseId, tenseName, count = 10) {
                setLoadingState(questionContainer, true, "AI ƒëang t·∫°o b·ªô c√¢u h·ªèi m·ªõi...");
                const prompt = `B·∫°n l√† m·ªôt chuy√™n gia ra ƒë·ªÅ thi ti·∫øng Anh cho ng∆∞·ªùi Vi·ªát. H√£y t·∫°o ${count} b√†i t·∫≠p ng·ªØ ph√°p ti·∫øng Anh, t·∫≠p trung v√†o th√¨ "${tenseName}" (tenseId: ${tenseId}). N·∫øu tenseId l√† 'all', h√£y t·∫°o b√†i t·∫≠p t·ªïng h·ª£p c√°c th√¨.
                C√°c b√†i t·∫≠p ph·∫£i ƒëa d·∫°ng, bao g·ªìm 4 lo·∫°i: 'mcq', 'fill', 'find_error', v√† 'reorder'.
                
                H√£y tr·∫£ v·ªÅ m·ªôt chu·ªói JSON h·ª£p l·ªá ch·ª©a m·ªôt m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng. M·ªói ƒë·ªëi t∆∞·ª£ng ph·∫£i c√≥ c√°c thu·ªôc t√≠nh sau:
                - "type": (string) m·ªôt trong c√°c gi√° tr·ªã "mcq", "fill", "find_error", "reorder".
                - "question": (string) N·ªôi dung c√¢u h·ªèi.
                - "options": (array of strings) Ch·ªâ d√†nh cho lo·∫°i "mcq".
                - "answer": (string) ƒê√°p √°n ƒë√∫ng. 
                - "explanation": (string) Gi·∫£i th√≠ch ng·∫Øn g·ªçn b·∫±ng ti·∫øng Vi·ªát t·∫°i sao ƒë√°p √°n ƒë√≥ ƒë√∫ng.
                - "words": (array of strings) Ch·ªâ d√†nh cho lo·∫°i "reorder", ch·ª©a c√°c t·ª´/c·ª•m t·ª´ c·∫ßn s·∫Øp x·∫øp.

                QUY T·∫ÆC C·ª∞C K·ª≤ QUAN TR·ªåNG:
                1.  **NG√îN NG·ªÆ C√ÇU H·ªéI:** Gi√° tr·ªã c·ªßa key "question" B·∫ÆT BU·ªòC ph·∫£i vi·∫øt 100% b·∫±ng ti·∫øng Anh. TUY·ªÜT ƒê·ªêI kh√¥ng ch√®n b·∫•t k·ª≥ t·ª´ ti·∫øng Vi·ªát n√†o v√†o c√¢u h·ªèi.
                2.  **C·∫§U TR√öC "FILL":** V·ªõi type "fill", c√¢u h·ªèi trong "question" ph·∫£i ƒë·∫∑t ƒë·ªông t·ª´ nguy√™n m·∫´u c·∫ßn chia trong d·∫•u ngo·∫∑c vu√¥ng. V√≠ d·ª•: "She [visit] Paris three times already.". ƒê√°p √°n trong "answer" n·∫øu c√≥ nhi·ªÅu ch·ªó tr·ªëng ph·∫£i ƒë∆∞·ª£c n·ªëi v·ªõi nhau b·∫±ng d·∫•u ph·∫©y KH√îNG c√≥ kho·∫£ng tr·∫Øng, v√≠ d·ª•: "has visited,did not go".
                3.  **C·∫§U TR√öC "FIND_ERROR":** V·ªõi type "find_error", c√¢u h·ªèi trong "question" ph·∫£i l√† m·ªôt c√¢u ho√†n ch·ªânh, trong ƒë√≥ c√≥ **√≠t nh·∫•t 3 v√† t·ªët nh·∫•t l√† 4** ph·∫ßn ƒë∆∞·ª£c b√¥i ƒë·∫≠m b·∫±ng d·∫•u \`** **\`. Ch·ªâ **m·ªôt** trong s·ªë c√°c ph·∫ßn ƒë∆∞·ª£c b√¥i ƒë·∫≠m ƒë√≥ ch·ª©a l·ªói sai. Gi√° tr·ªã c·ªßa key "answer" B·∫ÆT BU·ªòC ph·∫£i l√† ph·∫ßn vƒÉn b·∫£n ch·ª©a l·ªói sai ƒë√≥.
                4.  **C·∫§U TR√öC "REORDER":** V·ªõi type "reorder", "question" CH·ªà ƒë∆∞·ª£c ch·ª©a c√¢u ch·ªâ d·∫´n b·∫±ng ti·∫øng Anh. C√°c t·ª´ c·∫ßn s·∫Øp x·∫øp B·∫ÆT BU·ªòC ph·∫£i n·∫±m trong m·∫£ng "words". T·ª´ ƒë·∫ßu ti√™n c·ªßa c√¢u ph·∫£i ƒë∆∞·ª£c vi·∫øt hoa trong m·∫£ng "words".
                
                Ch·ªâ tr·∫£ v·ªÅ chu·ªói JSON, kh√¥ng c√≥ b·∫•t k·ª≥ vƒÉn b·∫£n n√†o kh√°c.`;

                const generationConfig = {
                    responseMimeType: "application/json",
                };

                const resultText = await callGemini(prompt, generationConfig);
                setLoadingState(questionContainer, false);
                if (resultText) {
                    try {
                        return JSON.parse(resultText);
                    } catch (e) {
                        console.error("Failed to parse JSON from Gemini:", e);
                        questionContainer.innerHTML = `<p class="text-red-500">ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o b√†i t·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.</p>`;
                        return [];
                    }
                }
                return [];
            }

            // --- RENDER FUNCTIONS ---
            function renderTenseDropdown() {
                tenseSelectDropdown.innerHTML = tenses.map(tense => `
                    <option value="${tense.id}" data-tense-name="${tense.name}">${tense.name}</option>
                `).join('');
            }

            function shuffleArray(array) {
                let currentIndex = array.length,  randomIndex;
                while (currentIndex != 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
                return array;
            }

            function renderQuestion() {
                 if (state.questions.length === 0) {
                    setLoadingState(questionContainer, true, "ƒêang t·∫£i c√¢u h·ªèi...");
                    return;
                }
                setLoadingState(questionContainer, false);
                const q = state.questions[state.currentQuestionIndex];
                const userAnswer = state.userAnswers[state.currentQuestionIndex] || {};
                
                let questionHtml = '';
                let answerHtml = '';
                
                switch (q.type) {
                    case 'mcq':
                        questionHtml = `<p class="text-lg">${q.question}</p>`;
                        answerHtml = `<div class="grid grid-cols-2 gap-4 w-full">` +
                        q.options.map(opt => `
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-slate-50 ${userAnswer.answer === opt ? 'border-indigo-500 bg-indigo-50' : 'border-slate-300'}">
                                <input type="radio" name="option" value="${opt}" class="mr-3" ${userAnswer.answer === opt ? 'checked' : ''}>
                                <span>${opt}</span>
                            </label>
                        `).join('') + `</div>`;
                        break;
                    case 'fill':
                        const verbs = q.question.match(/\[.*?\]/g) || [];
                        questionHtml = `<p class="text-lg">${q.question.replace(/\[.*?\]/g, '______')}</p>`;
                        
                        answerHtml = `<div class="flex flex-col gap-4 w-full">` +
                        verbs.map((verb, index) => {
                            const savedAnswers = userAnswer.answer ? userAnswer.answer.split(',') : [];
                            return `
                            <div class="flex items-center gap-2">
                                <label for="fill-input-${index}" class="font-medium text-slate-600">${verb.replace(/\[|\]/g, '')}:</label>
                                <input type="text" id="fill-input-${index}" value="${savedAnswers[index] || ''}" class="fill-input flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            `
                        }).join('') + `</div>`;
                        break;
                    case 'find_error':
                        questionHtml = `<p class="text-lg">Find the mistake in the following sentence:</p>`;
                        answerHtml = `<div class="w-full">
                                        <p class="text-xl mb-4">${q.question.replace(/\*\*(.*?)\*\*/g, `<span class="font-bold text-indigo-600 p-1 rounded-md cursor-pointer hover:bg-indigo-100 error-option" data-option="$1">$1</span>`)}</p>`;
                        if (userAnswer.answer) {
                            answerHtml += `<p class="mt-2 text-slate-600">You selected: <span class="font-bold">${userAnswer.answer}</span></p>`;
                        }
                        answerHtml += `</div>`;
                        break;
                    case 'reorder':
                        questionHtml = `<p class="text-lg">${q.question}</p>`;
                        const words = userAnswer.answer ? userAnswer.answer.split(' ') : shuffleArray([...q.words]);
                        answerHtml = `<div id="reorder-container" class="p-4 bg-slate-100 rounded-lg min-h-[60px] flex flex-wrap gap-2 border-2 border-slate-200">` +
                        words.map(word => `<div draggable="true" class="reorder-word p-2 bg-white rounded shadow cursor-move border">${word}</div>`).join('') +
                        `</div>`;
                        break;
                }

                questionContainer.innerHTML = `
                    <div class="exercise-frame min-h-[80px] flex items-center justify-center text-center">${questionHtml}</div>
                    <div class="my-3"></div>
                    <div class="exercise-frame min-h-[100px] flex items-center justify-center w-full">${answerHtml}</div>
                `;

                updateProgress();
                updateFeedback(userAnswer);
                
                if (q.type === 'find_error') addFindErrorListeners();
                if (q.type === 'reorder') addReorderListeners();
            }

            function updateProgress() {
                progressIndicator.textContent = `C√¢u ${state.currentQuestionIndex + 1} / ${state.questions.length}`;
                prevBtn.disabled = state.currentQuestionIndex === 0;
                nextBtn.disabled = state.currentQuestionIndex === state.questions.length - 1;
                prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
                nextBtn.classList.toggle('opacity-50', nextBtn.disabled);

                const answeredCount = state.userAnswers.filter(a => a && a.isCorrect !== undefined).length;
                if (state.questions.length > 0 && answeredCount === state.questions.length) {
                    loadMoreBtn.classList.remove('hidden');
                    finishSessionBtn.classList.remove('hidden');
                    checkBtn.classList.add('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                    checkBtn.classList.remove('hidden');
                }
            }

            function updateFeedback(userAnswer) {
                feedbackContainer.innerHTML = '';
                feedbackContainer.className = 'my-4 p-3 rounded-lg text-left font-medium';
                analyzeBtn.classList.add('hidden');

                if (userAnswer && userAnswer.isCorrect !== undefined) {
                    if (userAnswer.isCorrect) {
                        feedbackContainer.classList.add('bg-green-100', 'text-green-800');
                        feedbackContainer.innerHTML = `
                            <p class="font-bold text-center">üéâ Ch√≠nh x√°c! L√†m t·ªët l·∫Øm!</p>
                            <hr class="my-2 border-green-200">
                            <p><strong class="font-semibold">Gi·∫£i th√≠ch:</strong> ${userAnswer.question.explanation}</p>
                        `;
                    } else {
                        feedbackContainer.classList.add('bg-rose-100', 'text-rose-800');
                        feedbackContainer.innerHTML = '<p class="text-center">Ch∆∞a ƒë√∫ng. H√£y th·ª≠ l·∫°i ho·∫∑c xem ph√¢n t√≠ch t·ª´ AI nh√©!</p>';
                        analyzeBtn.classList.remove('hidden');
                    }
                }
            }

            function showView(viewName) {
                dashboardView.classList.add('hidden');
                learningView.classList.add('hidden');
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
            }

             function setLoadingState(element, isLoading, text = '') {
                if (isLoading) {
                    element.innerHTML = `<div class="flex flex-col items-center justify-center h-full">
                        <div class="loader mb-2"></div>
                        <p class="text-slate-500">${text}</p>
                    </div>`;
                } else {
                    element.innerHTML = '';
                }
            }

            function setButtonLoading(button, isLoading, originalText = '') {
                if (isLoading) {
                    button.disabled = true;
                    button.dataset.originalText = button.innerHTML;
                    button.innerHTML = `<div class="loader !w-5 !h-5 !border-2 !border-t-white"></div>`;
                } else {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalText || originalText;
                }
            }
            
            // --- DYNAMIC EVENT LISTENERS ---
            function addFindErrorListeners() {
                document.querySelectorAll('.error-option').forEach(span => {
                    span.addEventListener('click', () => {
                        document.querySelectorAll('.error-option').forEach(el => el.classList.remove('bg-indigo-200', 'ring-2', 'ring-indigo-400'));
                        span.classList.add('bg-indigo-200', 'ring-2', 'ring-indigo-400');
                        state.userAnswers[state.currentQuestionIndex] = { ...state.userAnswers[state.currentQuestionIndex], answer: span.dataset.option };
                        renderQuestion();
                    });
                });
            }

            function addReorderListeners() {
                const container = document.getElementById('reorder-container');
                if (!container) return; 
                let draggedItem = null;

                container.addEventListener('dragstart', e => {
                    if (e.target.classList.contains('reorder-word')) {
                        draggedItem = e.target;
                        setTimeout(() => {
                            e.target.classList.add('dragging');
                        }, 0);
                    }
                });

                container.addEventListener('dragend', e => {
                    if (draggedItem) {
                        setTimeout(() => {
                            draggedItem.classList.remove('dragging');
                            draggedItem = null;
                        }, 0);
                    }
                });

                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientX);
                    if (draggedItem) {
                        if (afterElement == null) {
                            container.appendChild(draggedItem);
                        } else {
                            container.insertBefore(draggedItem, afterElement);
                        }
                    }
                });
            }

            function getDragAfterElement(container, x) {
                const draggableElements = [...container.querySelectorAll('.reorder-word:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = x - box.left - box.width / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }


            // --- LOGIC & EVENT HANDLERS ---
            async function startSession(tenseId, tenseName, mode) {
                state.currentTenseId = tenseId;
                state.currentTenseName = tenseName;
                state.currentMode = mode;
                state.currentQuestionIndex = 0;
                state.userAnswers = [];
                state.questions = [];
                state.startTime = new Date();

                showView('learning');
                renderQuestion(); 

                if (mode === 'learning') {
                    theorySection.classList.remove('hidden');
                    exerciseSection.classList.remove('lg:col-span-5');
                    exerciseSection.classList.add('lg:col-span-3');
                    tenseTitle.textContent = tenseName;
                    tenseTheory.innerHTML = marked.parse(theoryData[tenseId] || 'L√Ω thuy·∫øt cho th√¨ n√†y ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t.');
                    exampleOutput.innerHTML = '';
                    exampleTopicInput.value = '';
                } else {
                    theorySection.classList.add('hidden');
                    exerciseSection.classList.remove('lg:col-span-3');
                    exerciseSection.classList.add('lg:col-span-5');
                    tenseTitle.textContent = "Luy·ªán t·∫≠p t·ªïng h·ª£p";
                }
                
                state.questions = await AIGenerateExercises(tenseId, tenseName);
                renderQuestion();
            }

            function checkAnswer() {
                const q = state.questions[state.currentQuestionIndex];
                let userAnswerValue;
                
                switch (q.type) {
                    case 'mcq':
                        userAnswerValue = questionContainer.querySelector('input[name="option"]:checked')?.value;
                        break;
                    case 'fill':
                        const inputs = Array.from(questionContainer.querySelectorAll('.fill-input'));
                        userAnswerValue = inputs.map(input => input.value.trim()).join(',');
                        break;
                    case 'find_error':
                        userAnswerValue = (state.userAnswers[state.currentQuestionIndex] || {}).answer;
                        break;
                    case 'reorder':
                        const words = Array.from(questionContainer.querySelectorAll('#reorder-container .reorder-word')).map(d => d.textContent);
                        userAnswerValue = words.join(' ');
                        break;
                }

                if (!userAnswerValue || (q.type === 'fill' && userAnswerValue.includes(',,'))) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß ƒë√°p √°n!');
                    return;
                }
                
                const normalize = (str) => {
                    if (typeof str !== 'string') return '';
                    return str.toLowerCase()
                              .replace(/\s+/g, ' ') // Standardize multiple spaces to one
                              .trim()
                              .replace(/\s+([,.?])/g, '$1') // Remove space before punctuation
                              .replace(/n't/g, ' not'); // Handle contractions
                };

                const normalizedUserAnswer = normalize(userAnswerValue);
                const normalizedCorrectAnswer = normalize(q.answer);
                const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;

                state.userAnswers[state.currentQuestionIndex] = {
                    answer: userAnswerValue,
                    isCorrect: isCorrect,
                    question: q,
                };
                
                renderQuestion();
            }

            async function showAIAnalysis() {
                const userAnswer = state.userAnswers[state.currentQuestionIndex];
                if (!userAnswer || userAnswer.isCorrect) return;

                aiModal.classList.remove('hidden');
                aiModal.classList.add('flex');
                setLoadingState(aiExplanation, true, "AI ƒëang ph√¢n t√≠ch...");

                const q = userAnswer.question;
                const prompt = `B·∫°n l√† m·ªôt gia s∆∞ ti·∫øng Anh t·∫≠n t√¢m. M·ªôt h·ªçc sinh Vi·ªát Nam ƒëang h·ªçc th√¨ "${state.currentTenseName}" v√† ƒë√£ tr·∫£ l·ªùi sai m·ªôt c√¢u h·ªèi.
                H√£y gi·∫£i th√≠ch l·ªói sai c·ªßa h·ªç m·ªôt c√°ch r√µ r√†ng, kh√≠ch l·ªá v√† d·ªÖ hi·ªÉu b·∫±ng ti·∫øng Vi·ªát.
                
                - C√¢u h·ªèi: ${q.question.replace(/\[.*?\]/g, '______').replace(/\*\*/g, '')}
                - C√¢u tr·∫£ l·ªùi c·ªßa h·ªçc sinh: ${userAnswer.answer}
                - ƒê√°p √°n ƒë√∫ng: ${q.answer}
                
                L·ªùi gi·∫£i th√≠ch c·ªßa b·∫°n n√™n:
                1. Ch·ªâ ra l·ªói sai n·∫±m ·ªü ƒë√¢u.
                2. Gi·∫£i th√≠ch quy t·∫Øc ng·ªØ ph√°p ƒë√∫ng.
                3. Cho m·ªôt v√≠ d·ª• ƒë√∫ng kh√°c ƒë·ªÉ minh h·ªça.
                4. ƒê∆∞a ra m·ªôt m·∫πo nh·ªè ƒë·ªÉ ghi nh·ªõ v√† tr√°nh l·ªói n√†y trong t∆∞∆°ng lai.
                
                S·ª≠ d·ª•ng Markdown ƒë·ªÉ ƒë·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi cho ƒë·∫πp m·∫Øt.`;

                const explanationText = await callGemini(prompt);
                setLoadingState(aiExplanation, false);
                if (explanationText) {
                    aiExplanation.innerHTML = marked.parse(explanationText);
                } else {
                    aiExplanation.innerHTML = "<p>R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra khi ph√¢n t√≠ch. Vui l√≤ng th·ª≠ l·∫°i.</p>";
                }
            }

            async function handleGenerateExamples() {
                const topic = exampleTopicInput.value.trim();
                if (!topic) {
                    alert("Vui l√≤ng nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ.");
                    return;
                }

                setButtonLoading(generateExampleBtn, true);
                setLoadingState(exampleOutput, true, "AI ƒëang vi·∫øt v√≠ d·ª•...");

                const prompt = `B·∫°n l√† m·ªôt gi√°o vi√™n ti·∫øng Anh. H√£y vi·∫øt 3 c√¢u v√≠ d·ª• th·ª±c t·∫ø cho m·ªôt h·ªçc sinh Vi·ªát Nam s·ª≠ d·ª•ng th√¨ "${state.currentTenseName}".
                C√°c c√¢u v√≠ d·ª• ph·∫£i xoay quanh ch·ªß ƒë·ªÅ: "${topic}".
                V·ªõi m·ªói c√¢u, h√£y cung c·∫•p m·ªôt b·∫£n d·ªãch ti·∫øng Vi·ªát ng·∫Øn g·ªçn.
                
                D√πng Markdown ƒë·ªÉ ƒë·ªãnh d·∫°ng, v√≠ d·ª•:
                - **C√¢u 1:** [C√¢u ti·∫øng Anh]
                  - *D·ªãch:* [C√¢u ti·∫øng Vi·ªát]
                - **C√¢u 2:** ...`;
                
                const exampleText = await callGemini(prompt);
                setButtonLoading(generateExampleBtn, false, 'T·∫°o v√≠ d·ª•');
                setLoadingState(exampleOutput, false);

                if (exampleText) {
                    exampleOutput.innerHTML = marked.parse(exampleText);
                } else {
                    exampleOutput.innerHTML = "<p>Kh√¥ng th·ªÉ t·∫°o v√≠ d·ª• l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i.</p>";
                }
            }

            function generateReport() {
                const endTime = new Date();
                const duration = Math.round((endTime - state.startTime) / 1000);
                const correctAnswers = state.userAnswers.filter(a => a && a.isCorrect).length;
                const totalAnswered = state.userAnswers.filter(a => a).length;
                const accuracy = totalAnswered > 0 ? Math.round((correctAnswers / totalAnswered) * 100) : 0;

                const wrongAnswers = state.userAnswers.filter(a => a && !a.isCorrect);
                let commonErrorsHtml = '<li>Kh√¥ng c√≥ l·ªói sai n√†o!</li>';
                if (wrongAnswers.length > 0) {
                    commonErrorsHtml = wrongAnswers.map(wa => `
                        <li class="mb-2 p-2 bg-rose-50 rounded-md">
                            <p><strong>C√¢u h·ªèi:</strong> ${wa.question.question.replace(/\[.*?\]/g, '______').replace(/\*\*/g, '')}</p>
                            <p><strong>B·∫°n ch·ªçn:</strong> <span class="text-rose-700">${wa.answer}</span> | <strong>ƒê√°p √°n ƒë√∫ng:</strong> <span class="text-green-700">${wa.question.answer}</span></p>
                        </li>
                    `).join('');
                }

                reportContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div><p class="text-sm text-slate-500">Ho√†n th√†nh</p><p class="text-2xl font-bold">${totalAnswered}/${state.questions.length}</p></div>
                            <div><p class="text-sm text-slate-500">Ch√≠nh x√°c</p><p class="text-2xl font-bold text-green-600">${accuracy}%</p></div>
                            <div><p class="text-sm text-slate-500">Th·ªùi gian</p><p class="text-2xl font-bold">${Math.floor(duration/60)}m ${duration%60}s</p></div>
                        </div>
                        <hr>
                        <div><h4 class="font-bold text-lg mb-2">C√°c l·ªói sai c·∫ßn xem l·∫°i:</h4><ul class="space-y-2">${commonErrorsHtml}</ul></div>
                    </div>`;
                endSessionModal.classList.remove('flex');
                endSessionModal.classList.add('hidden');
                reportModal.classList.remove('hidden');
                reportModal.classList.add('flex');
            }
            
            function resetToDashboard() {
                state = { currentMode: 'dashboard', currentTenseId: null, currentTenseName: null, questions: [], currentQuestionIndex: 0, userAnswers: [], startTime: null };
                showView('dashboard');
                [aiModal, endSessionModal, reportModal].forEach(modal => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                });
            }

            // --- EVENT LISTENERS BINDING ---
            startLearningBtn.addEventListener('click', () => {
                const selectedOption = tenseSelectDropdown.options[tenseSelectDropdown.selectedIndex];
                const tenseId = selectedOption.value;
                const tenseName = selectedOption.dataset.tenseName;
                if (tenseId) {
                    startSession(tenseId, tenseName, 'learning');
                }
            });

            advancedPracticeBtn.addEventListener('click', () => {
                startSession('all', 'T·ªïng h·ª£p', 'advanced');
            });

            backToDashboardBtn.addEventListener('click', resetToDashboard);
            homeBtn.addEventListener('click', resetToDashboard);

            prevBtn.addEventListener('click', () => {
                if (state.currentQuestionIndex > 0) {
                    state.currentQuestionIndex--;
                    renderQuestion();
                }
            });

            nextBtn.addEventListener('click', () => {
                if (state.currentQuestionIndex < state.questions.length - 1) {
                    state.currentQuestionIndex++;
                    renderQuestion();
                }
            });
            
            checkBtn.addEventListener('click', checkAnswer);
            analyzeBtn.addEventListener('click', showAIAnalysis);
            loadMoreBtn.addEventListener('click', () => {
                startSession(state.currentTenseId, state.currentTenseName, state.currentMode);
            });
            generateExampleBtn.addEventListener('click', handleGenerateExamples);

            finishSessionBtn.addEventListener('click', () => {
                endSessionModal.classList.remove('hidden');
                endSessionModal.classList.add('flex');
            });
            
            // Modal controls
            closeAiModalBtn.addEventListener('click', () => { aiModal.classList.add('hidden'); aiModal.classList.remove('flex'); });
            cancelEndBtn.addEventListener('click', () => { endSessionModal.classList.add('hidden'); endSessionModal.classList.remove('flex'); });
            // Updated event listener
            confirmEndBtn.addEventListener('click', () => {
                resetToDashboard();
            });
            generateReportBtn.addEventListener('click', generateReport);
            closeReportModalBtn.addEventListener('click', () => { reportModal.classList.add('hidden'); reportModal.classList.remove('flex'); });

            // --- INITIALIZATION ---
            renderTenseDropdown();
            showView('dashboard');
        });
    </script>
</body>
</html>
