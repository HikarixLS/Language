<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz T·ª´ v·ª±ng IELTS - 1 s·∫£n ph·∫©m ƒë∆∞·ª£c t·∫°o v·ªõi The Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        .option-btn.correct {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            border-color: #16a34a; /* green-600 */
        }
        .option-btn.incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #dc2626; /* red-600 */
        }
        .option-btn:disabled {
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .prose {
            max-width: 100% !important;
        }
        .prose h3 { margin-top: 1em; margin-bottom: 0.5em; font-size: 1.25em; font-weight: 600;}
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose ul { margin-top: 0.5em; margin-bottom: 0.5em; padding-left: 1.5em; list-style-type: disc;}
        .prose li { margin-bottom: 0.25em;}
        .prose strong, .prose b { font-weight: 700; }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="quiz-container" class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 transition-all duration-500">
        
        <div id="start-screen" class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400 mb-1">Quiz T·ª´ v·ª±ng IELTS</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">1 s·∫£n ph·∫©m ƒë∆∞·ª£c t·∫°o v·ªõi The Forum</p>
            <p class="text-lg font-semibold text-amber-500 mb-4">‚ú® N√¢ng c·∫•p b·ªüi Gemini AI</p>
            <p class="mb-6 text-lg">H·ªçc t·ª´ v·ª±ng theo ch·ªß ƒë·ªÅ ho·∫∑c th·ª≠ th√°ch ng·∫´u nhi√™n!</p>
            
            <div class="mb-4">
                <label for="topic-input" class="block mb-2 text-left font-medium text-gray-700 dark:text-gray-300">Nh·∫≠p ch·ªß ƒë·ªÅ (v√≠ d·ª•: environment, technology):</label>
                <input type="text" id="topic-input" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ch·ªß ƒë·ªÅ b·∫•t k·ª≥...">
            </div>

            <button id="dynamic-start-btn" class="w-full mb-3 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-amber-300 dark:focus:ring-amber-800">
                ‚ú® B·∫Øt ƒë·∫ßu Quiz theo Ch·ªß ƒë·ªÅ
            </button>
            <button id="random-start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-800">
                B·∫Øt ƒë·∫ßu Quiz Ng·∫´u nhi√™n
            </button>
            <div id="start-loader" class="hidden mt-4 flex justify-center items-center">
                <div class="loader"></div>
                <p class="ml-4">AI ƒëang t·∫°o b·ªô c√¢u h·ªèi, vui l√≤ng ch·ªù...</p>
            </div>
            <p id="start-error" class="text-red-500 mt-4"></p>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div id="progress" class="text-lg font-semibold text-gray-600 dark:text-gray-400">C√¢u h·ªèi 1 / 10</div>
                <div id="score" class="text-lg font-bold text-indigo-600 dark:text-indigo-400">ƒêi·ªÉm: 0</div>
            </div>

            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-6 mb-6 min-h-[120px] flex items-center justify-center">
                <p id="definition" class="text-center text-xl font-medium"></p>
            </div>

            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            
            <div id="feedback" class="mt-6 text-center text-lg font-medium h-8"></div>

            <div id="gemini-explanation-container" class="hidden mt-4">
                <div id="gemini-explanation-loader" class="flex justify-center items-center p-4"><div class="loader"></div><p class="ml-4">Gemini ƒëang suy nghƒ©...</p></div>
                <div id="gemini-explanation-content" class="p-4 bg-indigo-50 dark:bg-gray-700 rounded-lg prose dark:prose-invert"></div>
            </div>
            
            <div id="action-buttons" class="hidden mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                 <button id="explain-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg text-lg">‚ú® Gi·∫£i th√≠ch s√¢u h∆°n</button>
                 <button id="next-btn" class="w-full bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg text-lg">C√¢u ti·∫øp theo</button>
            </div>
        </div>

        <div id="result-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Ho√†n th√†nh!</h2>
            <p class="text-2xl mb-2">ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n l√†:</p>
            <p id="final-score" class="text-5xl font-bold mb-8"></p>
            <p id="final-message" class="text-lg mb-6"></p>

            <button id="feedback-btn" class="hidden w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg mb-4">‚ú® Nh·∫≠n Ph·∫£n h·ªìi C√° nh√¢n h√≥a</button>
            <div id="gemini-feedback-container" class="hidden mt-4">
                 <div id="gemini-feedback-loader" class="flex justify-center items-center p-4"><div class="loader"></div><p class="ml-4">AI ƒëang ph√¢n t√≠ch l·ªói sai...</p></div>
                <div id="gemini-feedback-content" class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-left prose dark:prose-invert"></div>
            </div>

            <button id="story-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg text-lg mb-4">‚ú® T·∫°o c√¢u chuy·ªán √¥n t·∫≠p</button>
            <div id="gemini-story-container" class="hidden mt-4">
                 <div id="gemini-story-loader" class="flex justify-center items-center p-4"><div class="loader"></div><p class="ml-4">Gemini ƒëang s√°ng t√°c...</p></div>
                <div id="gemini-story-content" class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg text-left prose dark:prose-invert"></div>
            </div>
            
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="export-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl">üìÑ Xu·∫•t B√°o c√°o</button>
                <button id="restart-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-xl">Ch∆°i l·∫°i</button>
            </div>
        </div>
    </div>

    <script>
        const hardcodedWords = [ { word: 'abandon', definition: 'T·ª´ b·ªè ho·∫∑c r·ªùi b·ªè ai ƒë√≥/c√°i g√¨ ƒë√≥.' }, { word: 'abolish', definition: 'Ch√≠nh th·ª©c ch·∫•m d·ª©t m·ªôt h·ªá th·ªëng ho·∫∑c m·ªôt th·ªÉ ch·∫ø.' }, { word: 'accelerate', definition: 'L√†m cho c√°i g√¨ ƒë√≥ di·ªÖn ra nhanh h∆°n.' }, { word: 'accommodate', definition: 'Cung c·∫•p ƒë·ªß kh√¥ng gian cho; ƒë√°p ·ª©ng nhu c·∫ßu.' }, { word: 'accumulate', definition: 'Thu th·∫≠p ho·∫∑c t√≠ch l≈©y d·∫ßn d·∫ßn.' }, { word: 'accurate', definition: 'Ch√≠nh x√°c v√† ƒë√∫ng ƒë·∫Øn.' }, { word: 'achieve', definition: 'ƒê·∫°t ƒë∆∞·ª£c ƒëi·ªÅu g√¨ ƒë√≥ b·∫±ng n·ªó l·ª±c, k·ªπ nƒÉng ho·∫∑c l√≤ng d≈©ng c·∫£m.' }, { word: 'acknowledge', definition: 'Th·ª´a nh·∫≠n s·ª± th·∫≠t ho·∫∑c s·ª± t·ªìn t·∫°i c·ªßa c√°i g√¨ ƒë√≥.' }, { word: 'acquire', definition: 'C√≥ ƒë∆∞·ª£c ho·∫∑c mua ƒë∆∞·ª£c m·ªôt c√°i g√¨ ƒë√≥.' }, { word: 'adapt', definition: 'Thay ƒë·ªïi ƒë·ªÉ ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán m·ªõi.' }, { word: 'adequate', definition: 'ƒê·ªß t·ªët ho·∫∑c ƒë·ªß v·ªÅ s·ªë l∆∞·ª£ng cho m·ªôt m·ª•c ƒë√≠ch.' }, { word: 'adjacent', definition: 'N·∫±m ngay c·∫°nh ho·∫∑c s√°t b√™n.' }, { word: 'adjust', definition: 'Thay ƒë·ªïi m·ªôt ch√∫t ƒë·ªÉ l√†m cho n√≥ ph√π h·ª£p h∆°n.' }, { word: 'advocate', definition: 'C√¥ng khai ·ªßng h·ªô m·ªôt ch√≠nh s√°ch ho·∫∑c c√°ch l√†m c·ª• th·ªÉ.' }, { word: 'affect', definition: 'G√¢y ra s·ª± thay ƒë·ªïi cho ai ƒë√≥/c√°i g√¨ ƒë√≥; t√°c ƒë·ªông ƒë·∫øn.' }, { word: 'aggregate', definition: 'T·ªïng h·ª£p l·∫°i th√†nh m·ªôt t·ªïng th·ªÉ.' }, { word: 'aid', definition: 'Gi√∫p ƒë·ª° ho·∫∑c h·ªó tr·ª£ (ai ƒë√≥ ho·∫∑c c√°i g√¨ ƒë√≥).' }, { word: 'albeit', definition: 'M·∫∑c d√π.' }, { word: 'allocate', definition: 'Ph√¢n b·ªï ho·∫∑c ch·ªâ ƒë·ªãnh cho m·ªôt m·ª•c ƒë√≠ch c·ª• th·ªÉ.' }, { word: 'alter', definition: 'Thay ƒë·ªïi v·ªÅ t√≠nh ch·∫•t, th√†nh ph·∫ßn ho·∫∑c c·∫•u tr√∫c.' }, { word: 'alternative', definition: 'M·ªôt trong hai ho·∫∑c nhi·ªÅu kh·∫£ nƒÉng c√≥ s·∫µn.' }, { word: 'ambiguous', definition: 'C√≥ nhi·ªÅu h∆°n m·ªôt c√°ch hi·ªÉu; kh√¥ng r√µ r√†ng.' }, { word: 'amend', definition: 'Th·ª±c hi·ªán nh·ªØng thay ƒë·ªïi nh·ªè ƒë·ªÉ c·∫£i thi·ªán vƒÉn b·∫£n ho·∫∑c lu·∫≠t.' }, { word: 'analyze', definition: 'Ki·ªÉm tra chi ti·∫øt ƒë·ªÉ gi·∫£i th√≠ch v√† di·ªÖn gi·∫£i.' }, { word: 'annual', definition: 'X·∫£y ra m·ªói nƒÉm m·ªôt l·∫ßn.' }, { word: 'anticipate', definition: 'Mong ƒë·ª£i ho·∫∑c d·ª± ƒëo√°n.' }, { word: 'apparent', definition: 'R√µ r√†ng, d·ªÖ th·∫•y.' }, { word: 'appreciate', definition: 'C√¥ng nh·∫≠n gi√° tr·ªã ƒë·∫ßy ƒë·ªß c·ªßa; bi·∫øt ∆°n.' }, { word: 'approach', definition: 'Ti·∫øp c·∫≠n ho·∫∑c ƒë·∫øn g·∫ßn.' }, { word: 'appropriate', definition: 'Ph√π h·ª£p ho·∫∑c th√≠ch h·ª£p trong ho√†n c·∫£nh.' }, { word: 'assess', definition: 'ƒê√°nh gi√° ho·∫∑c ∆∞·ªõc t√≠nh b·∫£n ch·∫•t, kh·∫£ nƒÉng ho·∫∑c ch·∫•t l∆∞·ª£ng.' }, { word: 'assume', definition: 'Cho r·∫±ng ƒëi·ªÅu g√¨ ƒë√≥ l√† ƒë√∫ng m√† kh√¥ng c√≥ b·∫±ng ch·ª©ng.' }, { word: 'assure', definition: 'N√≥i v·ªõi ai ƒë√≥ m·ªôt c√°ch ch·∫Øc ch·∫Øn ƒë·ªÉ xua tan nghi ng·ªù c·ªßa h·ªç.' }, { word: 'attain', definition: 'Th√†nh c√¥ng trong vi·ªác ƒë·∫°t ƒë∆∞·ª£c ƒëi·ªÅu g√¨ ƒë√≥.' }, { word: 'aware', definition: 'C√≥ ki·∫øn th·ª©c ho·∫∑c nh·∫≠n th·ª©c v·ªÅ m·ªôt t√¨nh hu·ªëng.' }, { word: 'benefit', definition: 'M·ªôt l·ª£i th·∫ø ho·∫∑c l·ª£i √≠ch thu ƒë∆∞·ª£c t·ª´ c√°i g√¨ ƒë√≥.' }, { word: 'bias', definition: 'Th√†nh ki·∫øn ·ªßng h·ªô ho·∫∑c ch·ªëng l·∫°i m·ªôt ƒëi·ªÅu g√¨ ƒë√≥.' }, { word: 'capable', definition: 'C√≥ kh·∫£ nƒÉng ho·∫∑c nƒÉng l·ª±c ƒë·ªÉ l√†m ƒëi·ªÅu g√¨ ƒë√≥.' }, { word: 'capacity', definition: 'L∆∞·ª£ng t·ªëi ƒëa m√† m·ªôt c√°i g√¨ ƒë√≥ c√≥ th·ªÉ ch·ª©a.' }, { word: 'category', definition: 'M·ªôt l·ªõp ho·∫∑c b·ªô ph·∫≠n c·ªßa ng∆∞·ªùi ho·∫∑c v·∫≠t c√≥ ƒë·∫∑c ƒëi·ªÉm chung.' }, { word: 'cease', definition: 'D·ª´ng l·∫°i, k·∫øt th√∫c.' }, { word: 'challenge', definition: 'M·ªôt nhi·ªám v·ª• ho·∫∑c t√¨nh hu·ªëng m·ªõi v√† kh√≥ khƒÉn.' }, { word: 'cite', definition: 'Tr√≠ch d·∫´n (s√°ch, t√°c gi·∫£,...) l√†m b·∫±ng ch·ª©ng.' }, { word: 'clarify', definition: 'L√†m cho (m·ªôt ph√°t bi·ªÉu ho·∫∑c t√¨nh hu·ªëng) tr·ªü n√™n d·ªÖ hi·ªÉu h∆°n.' }, { word: 'coherent', definition: 'H·ª£p l√Ω, nh·∫•t qu√°n v√† c√≥ th·ªÉ hi·ªÉu ƒë∆∞·ª£c.' }, { word: 'coincide', definition: 'X·∫£y ra c√πng m·ªôt l√∫c.' }, { word: 'collapse', definition: 'S·ª•p ƒë·ªï ƒë·ªôt ng·ªôt.' }, { word: 'commence', definition: 'B·∫Øt ƒë·∫ßu.' }, { word: 'compatible', definition: 'C√≥ th·ªÉ t·ªìn t·∫°i ho·∫∑c x·∫£y ra c√πng nhau m√† kh√¥ng c√≥ xung ƒë·ªôt.' }, { word: 'compensate', definition: 'ƒê·ªÅn b√π cho ai ƒë√≥ v√¨ m·∫•t m√°t, ƒëau kh·ªï ho·∫∑c t·ªïn th∆∞∆°ng.' }, { word: 'compile', definition: 'T·∫°o ra b·∫±ng c√°ch t·∫≠p h·ª£p t√†i li·ªáu t·ª´ c√°c ngu·ªìn kh√°c.' }, { word: 'complex', definition: 'Bao g·ªìm nhi·ªÅu b·ªô ph·∫≠n kh√°c nhau v√† ƒë∆∞·ª£c k·∫øt n·ªëi v·ªõi nhau.' }, { word: 'component', definition: 'M·ªôt b·ªô ph·∫≠n ho·∫∑c y·∫øu t·ªë c·ªßa m·ªôt t·ªïng th·ªÉ l·ªõn h∆°n.' }, { word: 'comprehensive', definition: 'Bao g·ªìm t·∫•t c·∫£ ho·∫∑c g·∫ßn nh∆∞ t·∫•t c·∫£ c√°c y·∫øu t·ªë c·ªßa m·ªôt c√°i g√¨ ƒë√≥.' }, { word: 'comprise', definition: 'Bao g·ªìm; ƒë∆∞·ª£c t·∫°o th√†nh t·ª´.' }, { word: 'concept', definition: 'M·ªôt √Ω t∆∞·ªüng tr·ª´u t∆∞·ª£ng; m·ªôt kh√°i ni·ªám chung.' }, { word: 'conclude', definition: 'K·∫øt th√∫c; ƒë∆∞a ra m·ªôt ph√°n quy·∫øt b·∫±ng c√°ch suy lu·∫≠n.' }, { word: 'conduct', definition: 'T·ªï ch·ª©c v√† th·ª±c hi·ªán.' }, { word: 'confer', definition: 'Trao (m·ªôt danh hi·ªáu, b·∫±ng c·∫•p, l·ª£i √≠ch, ho·∫∑c quy·ªÅn).' }, { word: 'confirm', definition: 'X√°c l·∫≠p s·ª± th·∫≠t ho·∫∑c t√≠nh ƒë√∫ng ƒë·∫Øn c·ªßa (c√°i g√¨ ƒë√≥).' }, { word: 'conflict', definition: 'M·ªôt s·ª± b·∫•t ƒë·ªìng ho·∫∑c tranh c√£i nghi√™m tr·ªçng.' }, { word: 'consent', definition: 'S·ª± cho ph√©p ƒë·ªÉ ƒëi·ªÅu g√¨ ƒë√≥ x·∫£y ra ho·∫∑c th·ªèa thu·∫≠n l√†m ƒëi·ªÅu g√¨ ƒë√≥.' }, { word: 'considerable', definition: 'ƒê√°ng k·ªÉ v·ªÅ k√≠ch th∆∞·ªõc, s·ªë l∆∞·ª£ng ho·∫∑c m·ª©c ƒë·ªô.' }, { word: 'consist', definition: 'Bao g·ªìm; ƒë∆∞·ª£c c·∫•u th√†nh t·ª´.' }, { word: 'constant', definition: 'X·∫£y ra li√™n t·ª•c trong m·ªôt kho·∫£ng th·ªùi gian.' }, { word: 'constitute', definition: 'L√† (m·ªôt ph·∫ßn) c·ªßa m·ªôt t·ªïng th·ªÉ.' }, { word: 'constrain', definition: 'Bu·ªôc ho·∫∑c √©p bu·ªôc (ai ƒë√≥) l√†m m·ªôt h√†nh ƒë·ªông.' }, { word: 'construct', definition: 'X√¢y d·ª±ng ho·∫∑c d·ª±ng l√™n (m·ªôt c√°i g√¨ ƒë√≥, th∆∞·ªùng l√† m·ªôt t√≤a nh√†).' }, { word: 'consult', definition: 'T√¨m ki·∫øm th√¥ng tin ho·∫∑c l·ªùi khuy√™n t·ª´ (ai ƒë√≥ c√≥ chuy√™n m√¥n).' }, { word: 'consume', 'definition': 'ƒÇn, u·ªëng, ho·∫∑c ti√™u th·ª•.' }, { word: 'context', definition: 'C√°c ho√†n c·∫£nh h√¨nh th√†nh n√™n b·ªëi c·∫£nh cho m·ªôt s·ª± ki·ªán, ph√°t bi·ªÉu, ho·∫∑c √Ω t∆∞·ªüng.' }, { word: 'contrast', definition: 'Tr·∫°ng th√°i kh√°c bi·ªát r√µ r·ªát so v·ªõi m·ªôt c√°i g√¨ ƒë√≥ kh√°c khi ƒë∆∞·ª£c so s√°nh.' }, { word: 'contribute', definition: 'ƒê√≥ng g√≥p m·ªôt ph·∫ßn ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c ho·∫∑c cung c·∫•p m·ªôt c√°i g√¨ ƒë√≥.' }, { word: 'culture', definition: 'Phong t·ª•c, ngh·ªá thu·∫≠t, v√† th√†nh t·ª±u x√£ h·ªôi c·ªßa m·ªôt qu·ªëc gia, d√¢n t·ªôc.' }, { word: 'crucial', definition: 'C·ª±c k·ª≥ quan tr·ªçng trong s·ª± th√†nh c√¥ng hay th·∫•t b·∫°i c·ªßa m·ªôt c√°i g√¨ ƒë√≥.' } ];
        const dom = {
            startScreen: document.getElementById('start-screen'),
            quizScreen: document.getElementById('quiz-screen'),
            resultScreen: document.getElementById('result-screen'),
            startBtn: document.getElementById('random-start-btn'),
            dynamicStartBtn: document.getElementById('dynamic-start-btn'),
            nextBtn: document.getElementById('next-btn'),
            restartBtn: document.getElementById('restart-btn'),
            progressEl: document.getElementById('progress'),
            scoreEl: document.getElementById('score'),
            definitionEl: document.getElementById('definition'),
            optionsContainer: document.getElementById('options-container'),
            feedbackEl: document.getElementById('feedback'),
            finalScoreEl: document.getElementById('final-score'),
            finalMessageEl: document.getElementById('final-message'),
            actionButtons: document.getElementById('action-buttons'),
            topicInput: document.getElementById('topic-input'),
            startLoader: document.getElementById('start-loader'),
            startError: document.getElementById('start-error'),
            explainBtn: document.getElementById('explain-btn'),
            geminiExplanationContainer: document.getElementById('gemini-explanation-container'),
            geminiExplanationLoader: document.getElementById('gemini-explanation-loader'),
            geminiExplanationContent: document.getElementById('gemini-explanation-content'),
            storyBtn: document.getElementById('story-btn'),
            geminiStoryContainer: document.getElementById('gemini-story-container'),
            geminiStoryLoader: document.getElementById('gemini-story-loader'),
            geminiStoryContent: document.getElementById('gemini-story-content'),
            feedbackBtn: document.getElementById('feedback-btn'),
            geminiFeedbackContainer: document.getElementById('gemini-feedback-container'),
            geminiFeedbackLoader: document.getElementById('gemini-feedback-loader'),
            geminiFeedbackContent: document.getElementById('gemini-feedback-content'),
            exportBtn: document.getElementById('export-btn'),
        };

        let currentQuestionIndex, score;
        let questions = [], quizWords = [], incorrectWords = [];
        let rawFeedback = '', rawStory = '';
        const TOTAL_QUESTIONS = 10;

        // --- UTILITY FUNCTIONS ---
        
        function renderMarkdown(text) {
            let html = text
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>')
                .replace(/<\/ul>\n<ul>/g, '')
                .replace(/\n/g, '<br>');
            return html;
        }

        async function callGemini(prompt, generationConfig = null) {
            const apiKey = "AIzaSyDNQZm1JNAWEHfzJkqkFiHqCoziZ8teksA";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            if (generationConfig) {
                payload.generationConfig = generationConfig;
            }
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API error! status: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                }
                return "R·∫•t ti·∫øc, kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ AI.";
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi AI.";
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- QUIZ GENERATION & LIFECYCLE ---

        function generateRandomQuestions() {
            questions = [];
            quizWords = [];
            const wordsCopy = [...hardcodedWords];
            shuffleArray(wordsCopy);
            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                const correctAnswer = wordsCopy[i];
                quizWords.push(correctAnswer.word);
                const options = [correctAnswer];
                const wrongOptionsPool = hardcodedWords.filter(w => w.word !== correctAnswer.word);
                shuffleArray(wrongOptionsPool);
                for (let j = 0; j < 3; j++) {
                    options.push(wrongOptionsPool[j]);
                }
                shuffleArray(options);
                questions.push({ question: correctAnswer.definition, options: options.map(opt => opt.word), answer: correctAnswer.word });
            }
        }
        
        function startQuiz(isDynamic = false) {
            if (!isDynamic) {
                generateRandomQuestions();
            }
            dom.startScreen.classList.add('hidden');
            dom.resultScreen.classList.add('hidden');
            dom.quizScreen.classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0;
            incorrectWords = [];
            rawFeedback = '';
            rawStory = '';
            displayQuestion();
        }

        async function startDynamicQuiz() {
            const topic = dom.topicInput.value.trim();
            if (!topic) {
                dom.startError.textContent = "Vui l√≤ng nh·∫≠p m·ªôt ch·ªß ƒë·ªÅ.";
                return;
            }
            dom.startError.textContent = '';
            dom.startLoader.classList.remove('hidden');
            dom.dynamicStartBtn.disabled = true;
            dom.startBtn.disabled = true;

            const prompt = `Generate a JSON array of ${TOTAL_QUESTIONS} IELTS vocabulary quiz questions based on the topic: "${topic}". The user is a Vietnamese learner. The definitions MUST be in Vietnamese. The JSON structure for each question object MUST be: { "word": "the English word", "definition": "a simple definition in Vietnamese", "options": [ "incorrect_option_1", "incorrect_option_2", "incorrect_option_3" ] }. IMPORTANT: The "word" itself MUST NOT be in the "options" array. All words in the "options" array MUST be in English and relevant to the topic.`;
            const generationConfig = {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            word: { type: "STRING" },
                            definition: { type: "STRING" },
                            options: { type: "ARRAY", items: { type: "STRING" } }
                        },
                        required: ["word", "definition", "options"]
                    }
                }
            };
            
            const resultText = await callGemini(prompt, generationConfig);
            dom.startLoader.classList.add('hidden');
            dom.dynamicStartBtn.disabled = false;
            dom.startBtn.disabled = false;

            try {
                const generatedQuestions = JSON.parse(resultText);
                questions = generatedQuestions.map(q => {
                    const allOptions = [...q.options, q.word];
                    shuffleArray(allOptions);
                    return { question: q.definition, options: allOptions, answer: q.word };
                });
                quizWords = questions.map(q => q.answer);
                startQuiz(true);
            } catch (e) {
                console.error("Failed to parse AI response:", e, resultText);
                dom.startError.textContent = "AI kh√¥ng th·ªÉ t·∫°o c√¢u h·ªèi. Vui l√≤ng th·ª≠ l·∫°i v·ªõi ch·ªß ƒë·ªÅ kh√°c.";
            }
        }

        function displayQuestion() {
            resetState();
            const currentQuestion = questions[currentQuestionIndex];
            dom.progressEl.textContent = `C√¢u h·ªèi ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS}`;
            dom.scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
            dom.definitionEl.textContent = currentQuestion.question;
            currentQuestion.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn', 'w-full', 'p-4', 'border-2', 'border-gray-300', 'dark:border-gray-600', 'rounded-lg', 'text-lg', 'transition-all', 'hover:bg-gray-200', 'dark:hover:bg-gray-700');
                button.addEventListener('click', () => selectAnswer(button, option));
                dom.optionsContainer.appendChild(button);
            });
        }
        
        function resetState() {
            dom.actionButtons.classList.add('hidden');
            dom.feedbackEl.textContent = '';
            dom.geminiExplanationContainer.classList.add('hidden');
            dom.geminiExplanationContent.innerHTML = '';
            dom.explainBtn.disabled = false;
            while (dom.optionsContainer.firstChild) {
                dom.optionsContainer.removeChild(dom.optionsContainer.firstChild);
            }
        }

        function selectAnswer(button, selectedWord) {
            const correctAnswer = questions[currentQuestionIndex].answer;
            const isCorrect = selectedWord === correctAnswer;
            if (isCorrect) {
                score++;
                dom.feedbackEl.textContent = 'Ch√≠nh x√°c!';
                dom.feedbackEl.classList.add('text-green-500');
                dom.feedbackEl.classList.remove('text-red-500');
            } else {
                dom.feedbackEl.textContent = `Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: ${correctAnswer}`;
                dom.feedbackEl.classList.add('text-red-500');
                dom.feedbackEl.classList.remove('text-green-500');
                incorrectWords.push({word: correctAnswer, yourAnswer: selectedWord});
            }
            dom.scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
            Array.from(dom.optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) btn.classList.add('correct');
                else if (btn === button) btn.classList.add('incorrect');
            });
            dom.actionButtons.classList.remove('hidden');
        }

        function showNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < TOTAL_QUESTIONS) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            dom.quizScreen.classList.add('hidden');
            dom.resultScreen.classList.remove('hidden');
            dom.finalScoreEl.textContent = `${score} / ${TOTAL_QUESTIONS}`;
            
            dom.storyBtn.disabled = false;
            dom.geminiStoryContainer.classList.add('hidden');
            dom.geminiStoryContent.innerHTML = '';
            
            dom.feedbackBtn.disabled = false;
            dom.geminiFeedbackContainer.classList.add('hidden');
            dom.geminiFeedbackContent.innerHTML = '';
            if (incorrectWords.length > 0) {
                dom.feedbackBtn.classList.remove('hidden');
            } else {
                dom.feedbackBtn.classList.add('hidden');
            }

            let message = '';
            const percentage = (score / TOTAL_QUESTIONS) * 100;
            if (percentage === 100) message = 'Tuy·ªát v·ªùi! B·∫°n l√† m·ªôt b·∫≠c th·∫ßy t·ª´ v·ª±ng!';
            else if (percentage >= 80) message = 'R·∫•t t·ªët! V·ªën t·ª´ v·ª±ng c·ªßa b·∫°n th·∫≠t ·∫•n t∆∞·ª£ng.';
            else if (percentage >= 50) message = 'Kh√° l·∫Øm! H√£y ti·∫øp t·ª•c luy·ªán t·∫≠p nh√©.';
            else message = 'ƒê·ª´ng n·∫£n l√≤ng! Luy·ªán t·∫≠p th√™m s·∫Ω gi√∫p b·∫°n ti·∫øn b·ªô.';
            dom.finalMessageEl.textContent = message;
        }

        // --- GEMINI API FEATURES ---

        async function getExplanation() {
            dom.explainBtn.disabled = true;
            dom.geminiExplanationContainer.classList.remove('hidden');
            dom.geminiExplanationContent.classList.add('hidden');
            dom.geminiExplanationLoader.classList.remove('hidden');
            const word = questions[currentQuestionIndex].answer;
            const prompt = `H√£y gi·∫£i th√≠ch t·ª´ v·ª±ng IELTS "${word}" cho ng∆∞·ªùi h·ªçc ti·∫øng Vi·ªát. Cung c·∫•p:\n1. 2-3 c√¢u v√≠ d·ª• b·∫±ng ti·∫øng Anh v√† d·ªãch sang ti·∫øng Vi·ªát.\n2. C√°c c·ª•m t·ª´ (collocations) ph·ªï bi·∫øn.\n3. M·ªôt t·ª´ ƒë·ªìng nghƒ©a (synonym) quan tr·ªçng. ƒê·ªãnh d·∫°ng b·∫±ng Markdown, s·ª≠ d·ª•ng ti√™u ƒë·ªÅ (###) v√† danh s√°ch (*).`;
            const explanation = await callGemini(prompt);
            dom.geminiExplanationLoader.classList.add('hidden');
            dom.geminiExplanationContent.innerHTML = renderMarkdown(explanation);
            dom.geminiExplanationContent.classList.remove('hidden');
        }

        async function generateStory() {
            dom.storyBtn.disabled = true;
            dom.geminiStoryContainer.classList.remove('hidden');
            dom.geminiStoryContent.classList.add('hidden');
            dom.geminiStoryLoader.classList.remove('hidden');
            const wordsString = quizWords.join(', ');
            const prompt = `Vi·∫øt m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn (kho·∫£ng 50-70 t·ª´) d√†nh cho ng∆∞·ªùi h·ªçc IELTS, s·ª≠ d·ª•ng c√°c t·ª´ sau: ${wordsString}. H√£y l√†m cho c√¢u chuy·ªán m·∫°ch l·∫°c v√† d·ªÖ hi·ªÉu. ƒê·ªãnh d·∫°ng b·∫±ng Markdown v√† **in ƒë·∫≠m** c√°c t·ª´ kh√≥a.`;
            rawStory = await callGemini(prompt);
            dom.geminiStoryLoader.classList.add('hidden');
            dom.geminiStoryContent.innerHTML = renderMarkdown(rawStory);
            dom.geminiStoryContent.classList.remove('hidden');
        }

        async function getPersonalizedFeedback() {
            dom.feedbackBtn.disabled = true;
            dom.geminiFeedbackContainer.classList.remove('hidden');
            dom.geminiFeedbackContent.classList.add('hidden');
            dom.geminiFeedbackLoader.classList.remove('hidden');
            const wordsString = incorrectWords.map(item => item.word).join(', ');
            const prompt = `M·ªôt h·ªçc sinh IELTS ƒë√£ tr·∫£ l·ªùi sai c√°c c√¢u h·ªèi v·ªÅ nh·ªØng t·ª´ sau: ${wordsString}. H√£y ƒë∆∞a ra ph·∫£n h·ªìi mang t√≠nh x√¢y d·ª±ng v√† c√° nh√¢n h√≥a b·∫±ng ti·∫øng Vi·ªát, s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown. Bao g·ªìm:\n- M·ªôt ti√™u ƒë·ªÅ ch√≠nh (v√≠ d·ª•: "### Ph√¢n t√≠ch v√† G·ª£i √Ω").\n- Ph√¢n t√≠ch v·ªÅ ƒëi·ªÉm chung c·ªßa c√°c t·ª´ sai (n·∫øu c√≥).\n- M·ªôt m·∫πo h·ªçc t·∫≠p ƒë∆°n gi·∫£n v√† hi·ªáu qu·∫£.`;
            rawFeedback = await callGemini(prompt);
            dom.geminiFeedbackLoader.classList.add('hidden');
            dom.geminiFeedbackContent.innerHTML = renderMarkdown(rawFeedback);
            dom.geminiFeedbackContent.classList.remove('hidden');
        }
        
        // --- EXPORT FUNCTIONALITY ---

        function generateMarkdownReport() {
            let report = `# B√°o c√°o K·∫øt qu·∫£ Quiz IELTS\n\n`;
            report += `*1 s·∫£n ph·∫©m ƒë∆∞·ª£c t·∫°o v·ªõi The Forum*\n\n`;
            report += `## 1. T·ªïng k·∫øt\n`;
            report += `- **ƒêi·ªÉm s·ªë:** ${score} / ${TOTAL_QUESTIONS}\n`;
            report += `- **Ng√†y l√†m:** ${new Date().toLocaleDateString('vi-VN')}\n\n`;

            report += `## 2. C√°c t·ª´ v·ª±ng ƒë√£ h·ªçc\n`;
            quizWords.forEach(word => {
                report += `- ${word}\n`;
            });
            report += `\n`;

            if (incorrectWords.length > 0) {
                report += `## 3. C√°c t·ª´ tr·∫£ l·ªùi sai\n`;
                incorrectWords.forEach(item => {
                    report += `- **${item.word}** (B·∫°n ƒë√£ ch·ªçn: ${item.yourAnswer})\n`;
                });
                report += `\n`;
            } else {
                 report += `## 3. C√°c t·ª´ tr·∫£ l·ªùi sai\n`;
                 report += `Ch√∫c m·ª´ng! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi.\n\n`;
            }

            if (rawFeedback) {
                report += `## 4. Ph·∫£n h·ªìi c√° nh√¢n h√≥a t·ª´ AI\n`;
                report += rawFeedback + '\n\n';
            }

            if (rawStory) {
                report += `## 5. C√¢u chuy·ªán √¥n t·∫≠p t·ª´ AI\n`;
                report += rawStory + '\n\n';
            }
            
            return report;
        }

        function exportResults() {
            const markdownContent = generateMarkdownReport();
            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'IELTS_Quiz_Report.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- EVENT LISTENERS ---
        dom.startBtn.addEventListener('click', () => startQuiz(false));
        dom.dynamicStartBtn.addEventListener('click', startDynamicQuiz);
        dom.nextBtn.addEventListener('click', showNextQuestion);
        dom.restartBtn.addEventListener('click', () => {
            dom.resultScreen.classList.add('hidden');
            dom.startScreen.classList.remove('hidden');
        });
        dom.explainBtn.addEventListener('click', getExplanation);
        dom.storyBtn.addEventListener('click', generateStory);
        dom.feedbackBtn.addEventListener('click', getPersonalizedFeedback);
        dom.exportBtn.addEventListener('click', exportResults);
    </script>
</body>
</html>
